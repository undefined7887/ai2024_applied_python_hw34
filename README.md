# URL Shortener

Простой сервер для сокращения ссылок с возможностью авторизации пользователей

## Запуск приложения локально

```bash
$ cp .env.example .env
$ docker compose up --build
```

Приложение будет доступно по адресу `http://localhost:8000`.

## Запуск тестов

```bash
$ pytest tests
```

Отчет по покрытию можно посмотреть в `coverage_report/index.html`.

## Запуск нагрузочного тестирования

Перед запуском нагрузочного тестирования убедитесь, что приложение работает локально

```bash
$ chmod +x locust.sh
$ ./locust.sh
```

## Функциональность приложения

### 1. Регистрация и авторизация

### POST /auth/register

- **Описание**: Создаёт нового пользователя.
- **Авторизация**: не требуется.
- **Тело запроса (JSON)**:

```json
{
  "username": "string",
  "password": "string"
}
```

- **Ответ**:
    - При успехе (`200`):
      ```json
      {
        "id": "string (uuid)" // Уникальный идентификатор пользователя
      }
      ```
    - При конфликте (`409`): Если пользователь уже существует.

---

### POST /auth/token

- **Описание**: Возвращает JWT-токен для аутентификации.
- **Авторизация**: не требуется.
- **Тело запроса (JSON)**:

```json
{
  "username": "string",
  "password": "string"
}
```

- **Ответ**:
    - При успехе (`200`):
      ```json
      {
        "access_token": "string"
      }
      ```
    - При ошибке (`401`): Неверное имя пользователя или пароль.

---

### 2. Управление ссылками

### POST /links/shorten

- **Описание**: Создаёт новую короткую ссылку (с возможным alias).
- **Авторизация**: не требуется (но если пользователь авторизован, ссылка будет привязана к нему).
- **Тело запроса (JSON)**:

```json
{
  "url": "string",
  "expire_at": "string (datetime)",
  "alias": "string (необязательный)"
}
```

- **Ответ**:
    - При успехе (`200`):
      ```json
      {
        "id": "string (alias)"
      }
      ```
    - При ошибке (`400`): Некорректная дата истечения (expire_at уже в прошлом).
    - При конфликте (`409`): Выбранный alias уже существует.

---

### GET /links

- **Описание**: Возвращает все ссылки, принадлежащие авторизованному пользователю.
- **Авторизация**: требуется (Bearer-токен).
- **Тело запроса**: отсутствует.
- **Ответ**:
    - При успехе (`200`):
      ```json
      {
        "links": [
          {
            "id": "string",
            "url": "string",
            "access_count": 0,
            "last_access_at": "datetime или null",
            "created_at": "datetime",
            "updated_at": "datetime",
            "expire_at": "datetime"
          }
        ]
      }
      ```
    - При ошибке авторизации (`401`): Если нет или неверный токен.

---

### GET /links/search

- **Описание**: Ищет ссылки по фрагменту исходного URL среди ссылок авторизованного пользователя.
- **Авторизация**: требуется (Bearer-токен).
- **Параметры**:
    - `original_url`: строка, которая будет искаться в поле `Link.url`.
- **Ответ**:
    - При успехе (`200`):
      ```json
      {
        "links": [
          // ... ссылки, которые содержат original_url
        ]
      }
      ```
    - При отсутствии параметра (`400`).
    - При ошибке авторизации (`401`).

**Пример**: `GET /links/search?original_url=example`

---

### GET /links/{link_id}

- **Описание**: Редирект по короткой ссылке на исходный URL.
- **Авторизация**: не требуется (ссылка может быть и без владельца).
- **Параметры**:
    - `{link_id}`: ID или alias короткой ссылки.
- **Ответ**:
    - При успехе (`301`): Перенаправляет на исходный адрес (устанавливает заголовок `Location`).
    - При ошибке (`404`): Если ссылка не найдена или истекла.

---

### GET /links/{link_id}/stats

- **Описание**: Выдаёт статистику по ссылке: счётчик переходов, дата последнего доступа и т.д.
- **Авторизация**: требуется (Bearer-токен).
- **Параметры**:
    - `{link_id}`: ID или alias ссылки.
- **Ответ**:
    - При успехе (`200`):
      ```json
      {
        "id": "string",
        "url": "string",
        "access_count": 0,
        "last_access_at": "datetime или null",
        "created_at": "datetime",
        "updated_at": "datetime",
        "expire_at": "datetime"
      }
      ```
    - При ошибке (`404`): Если ссылки нет или она не принадлежит пользователю.
    - При ошибке авторизации (`401`).

---

### PUT /links/{link_id}

- **Описание**: Обновляет `url` у существующей короткой ссылки (только владелец).
- **Авторизация**: требуется (Bearer-токен).
- **Тело запроса (JSON)**:

```json
{
  "url": "string"
}
```

- **Ответ**:
    - При успехе (`204 No Content`): Поле `url` обновлено.
    - При ошибке (`404`): Ссылка не найдена или не принадлежит пользователю.
    - При ошибке авторизации (`401`).

---

### DELETE /links/{link_id}

- **Описание**: Удаляет ссылку из БД и соответствующую запись в Redis (если есть).
- **Авторизация**: требуется (Bearer-токен).
- **Параметры**:
    - `{link_id}`: ID или alias ссылки.
- **Ответ**:
    - При успехе (`204 No Content`).
    - При ошибке (`404`): Ссылка не найдена или не принадлежит пользователю.
    - При ошибке авторизации (`401`).

---

## Структура базы данных

В файле `sql.py` описаны модели на базе **SQLAlchemy**:

### Таблица `user`

- `id` (`str`, PK) — генерируется через UUID4.
- `nickname` (`str`, уникальное поле).
- `password_hash` (`str`) — хранит хэш пароля.
- Связь: `links` — список связанных ссылок (`Link`).

### Таблица `link`

- `id` (`str`, PK) — генерируется короткой строкой (или задаётся вручную в `alias`).
- `user_id` (`str | null`) — внешний ключ на `user.id`. Может быть `NULL`, если ссылка не привязана к пользователю.
- `url` (`str`) — исходный URL.
- `access_count` (`int`) — счётчик переходов.
- `last_access_at` (`datetime | null`) — время последнего перехода.
- `created_at` (`datetime`) — дата создания.
- `updated_at` (`datetime`) — дата последнего обновления.
- `expire_at` (`datetime`) — дата и время истечения.

